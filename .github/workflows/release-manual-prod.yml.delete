name: Manually release prod with latest tag

on:
  push:
    branches: [master]
  workflow_dispatch:
    branches: [master]

jobs:
  release:
    name: Release prod
    runs-on: ubuntu-18.04
    environment: prod
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0 # required for making tag detection work
      - name: Get latest tag
        id: latest-tag
        uses: WyriHaximus/github-action-get-previous-tag@v1
      - name: Find tag revision
        id: latest-tag-rev
        run: |
          TAG_REV=$(git rev-list -n 1 ${{ steps.latest-tag.outputs.tag }})
          echo "::set-output name=revision::$TAG_REV"
      - name: Release
        id: release
        uses: ./.github/actions/release
        with:
          version: ${{ steps.latest-tag.outputs.tag }}
          revision: ${{ steps.latest-tag-rev.outputs.revision }}
          aws_access_key: ${{ secrets.PROD_RELEASE_AWS_ACCESS_KEY }}
          aws_secret_key: ${{ secrets.PROD_RELEASE_AWS_SECRET_KEY }}
          build_artifacts_bucket_name: prod-forta-build-artifacts
          release_artifacts_bucket_name: prod-forta-releases
          release_artifacts_url: https://dist.forta.network/artifacts
          dist_base_url: https://dist.forta.network
          pgp_key_name: ${{ secrets.PROD_PGP_KEY_NAME }}
          pgp_private_key: ${{ secrets.PROD_PGP_PRIVATE_KEY }}
          pgp_public_key: ${{ secrets.PROD_PGP_PUBLIC_KEY }}
          pgp_passphrase: ${{ secrets.PROD_PGP_PASSPHRASE }}
